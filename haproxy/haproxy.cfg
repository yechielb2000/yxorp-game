global
    maxconn 2048
    log stdout format raw local0
    tune.maxaccept 1000           # Max accept calls per iteration, controls accept bursts

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull            # Don't log connections that were rejected (reduces noise)
    timeout connect 5s
    timeout client  30s
    timeout server  30s

frontend http_in
    bind *:80
    default_backend nginx_backend

    # Stick-table to track connections per source IP
    stick-table type ip size 1m expire 30s store conn_rate(3s),conn_cur

    tcp-request connection track-sc0 src

    # Reject if connection rate > 20 per second from one IP
    tcp-request connection reject if { sc_conn_rate(0) gt 20 }

    # Reject if more than 100 concurrent connections from one IP
    tcp-request connection reject if { sc_conn_cur(0) gt 100 }

backend nginx_backend
    server nginx nginx:8080 check
